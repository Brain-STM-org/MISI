---
/**
 * Header component with chapter info and reading progress
 */
import type { ChapterMeta } from '../lib/types';
import { tierDescriptions } from '../lib/chapters';
import SearchTrigger from './SearchTrigger';

interface Props {
  title: string;
  chapter?: ChapterMeta;
}

const { title, chapter } = Astro.props;
---

<header class="sticky top-0 z-20 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800">
  <div class="px-4 lg:px-8 py-4 max-w-4xl mx-auto">
    <div class="flex items-center justify-between">
      <div>
        {chapter && (
          <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-1">
            <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded text-xs font-medium">
              Tier {chapter.tier}
            </span>
            <span>•</span>
            <span>Chapter {chapter.number}</span>
            <span>•</span>
            <span>{chapter.estimatedMinutes} min read</span>
          </div>
        )}
        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">{title}</h1>
      </div>

      <div class="flex items-center gap-2">
        <!-- Font size controls -->
        <div class="hidden sm:flex items-center gap-1 mr-2" role="group" aria-label="Font size">
          <button
            id="font-sm"
            class="font-size-btn px-2 py-1 text-xs rounded transition-colors text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 focus-ring"
            aria-label="Small font size"
            aria-pressed="false"
            title="Small text"
          >A</button>
          <button
            id="font-md"
            class="font-size-btn px-2 py-1 text-sm rounded transition-colors text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 focus-ring"
            aria-label="Medium font size"
            aria-pressed="true"
            title="Medium text"
          >A</button>
          <button
            id="font-lg"
            class="font-size-btn px-2 py-1 text-base rounded transition-colors text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 focus-ring"
            aria-label="Large font size"
            aria-pressed="false"
            title="Large text"
          >A</button>
        </div>

        <!-- Focus mode toggle -->
        <button
          id="focus-mode-btn"
          class="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors focus-ring"
          aria-label="Toggle focus mode"
          aria-pressed="false"
          title="Focus mode - hide navigation"
        >
          <svg class="w-5 h-5 focus-off" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <svg class="w-5 h-5 focus-on hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
          </svg>
        </button>

        <!-- Search -->
        <SearchTrigger client:only="react" />

        {chapter && (
          <!-- Mark as complete button -->
          <button
            id="mark-complete-btn"
            data-chapter-slug={chapter.slug}
            class="hidden sm:block px-3 py-1.5 text-sm font-medium text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/30 rounded-lg transition-colors focus-ring"
          >
            <span class="complete-text">Mark complete</span>
            <span class="completed-text hidden">✓ Completed</span>
          </button>
        )}
      </div>
    </div>

    <!-- Reading progress bar -->
    {chapter && (
      <div class="mt-3">
        <div class="h-1 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
          <div
            id="reading-progress"
            class="h-full bg-blue-500 rounded-full transition-all duration-150"
            style="width: 0%"
          ></div>
        </div>
      </div>
    )}
  </div>
</header>

<script>
  import { progressStore, startChapter, completeChapter, updateReadProgress, updateSettings } from '../lib/progress';
  import { announce } from '../lib/a11y';

  const btn = document.getElementById('mark-complete-btn') as HTMLButtonElement;
  const progressBar = document.getElementById('reading-progress');
  const chapterSlug = btn?.dataset.chapterSlug;

  if (chapterSlug) {
    // Mark chapter as started
    startChapter(chapterSlug);

    // Update button state based on current progress
    function updateButtonState() {
      const progress = progressStore.get();
      const isComplete = progress.chapters[chapterSlug]?.completed;

      if (btn) {
        const completeText = btn.querySelector('.complete-text');
        const completedText = btn.querySelector('.completed-text');

        if (isComplete) {
          completeText?.classList.add('hidden');
          completedText?.classList.remove('hidden');
          btn.disabled = true;
          btn.classList.add('cursor-default');
        }
      }
    }

    progressStore.subscribe(updateButtonState);
    updateButtonState();

    // Handle mark complete click
    btn?.addEventListener('click', () => {
      completeChapter(chapterSlug);
    });

    // Track scroll progress
    function updateScrollProgress() {
      const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrolled = window.scrollY;
      const progress = scrollHeight > 0 ? Math.round((scrolled / scrollHeight) * 100) : 0;

      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }

      // Update stored progress (debounced via the scroll handler)
      updateReadProgress(chapterSlug, progress);
    }

    // Debounced scroll handler
    let scrollTimeout: number;
    window.addEventListener('scroll', () => {
      if (progressBar) {
        const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrolled = window.scrollY;
        const progress = scrollHeight > 0 ? Math.round((scrolled / scrollHeight) * 100) : 0;
        progressBar.style.width = `${progress}%`;
      }

      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateScrollProgress, 200) as unknown as number;
    });

    // Initial progress from stored state
    const stored = progressStore.get();
    const storedProgress = stored.chapters[chapterSlug]?.readProgress || 0;
    if (progressBar && storedProgress > 0) {
      progressBar.style.width = `${storedProgress}%`;
    }
  }

  // Font size controls
  const fontBtns = document.querySelectorAll('.font-size-btn');
  const fontSizes = ['sm', 'md', 'lg'] as const;
  const fontLabels = { sm: 'Small', md: 'Medium', lg: 'Large' };

  function updateFontSizeUI(size: 'sm' | 'md' | 'lg') {
    // Update body class
    document.body.classList.remove('font-size-sm', 'font-size-md', 'font-size-lg');
    document.body.classList.add(`font-size-${size}`);

    // Update button states
    fontBtns.forEach((btn) => {
      const btnSize = btn.id.replace('font-', '') as 'sm' | 'md' | 'lg';
      const isActive = btnSize === size;
      btn.setAttribute('aria-pressed', String(isActive));
      if (isActive) {
        btn.classList.add('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-700', 'dark:text-blue-300');
        btn.classList.remove('text-gray-500', 'dark:text-gray-400');
      } else {
        btn.classList.remove('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-700', 'dark:text-blue-300');
        btn.classList.add('text-gray-500', 'dark:text-gray-400');
      }
    });
  }

  fontBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const size = btn.id.replace('font-', '') as 'sm' | 'md' | 'lg';
      updateSettings({ fontSize: size });
      announce(`Font size: ${fontLabels[size]}`);
    });
  });

  // Focus mode toggle
  const focusModeBtn = document.getElementById('focus-mode-btn');
  const focusOnIcon = focusModeBtn?.querySelector('.focus-on');
  const focusOffIcon = focusModeBtn?.querySelector('.focus-off');

  function updateFocusModeUI(enabled: boolean) {
    if (enabled) {
      document.body.classList.add('focus-mode');
      focusModeBtn?.setAttribute('aria-pressed', 'true');
      focusModeBtn?.setAttribute('aria-label', 'Exit focus mode');
      focusOnIcon?.classList.remove('hidden');
      focusOffIcon?.classList.add('hidden');
    } else {
      document.body.classList.remove('focus-mode');
      focusModeBtn?.setAttribute('aria-pressed', 'false');
      focusModeBtn?.setAttribute('aria-label', 'Enter focus mode');
      focusOnIcon?.classList.add('hidden');
      focusOffIcon?.classList.remove('hidden');
    }
  }

  focusModeBtn?.addEventListener('click', () => {
    const current = progressStore.get();
    const newFocusMode = !current.settings.focusMode;
    updateSettings({ focusMode: newFocusMode });
    announce(newFocusMode ? 'Focus mode enabled' : 'Focus mode disabled');
  });

  // Keyboard shortcut for focus mode (F key when not in input)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'f' && !['INPUT', 'TEXTAREA', 'SELECT'].includes((e.target as HTMLElement)?.tagName)) {
      e.preventDefault();
      const current = progressStore.get();
      const newFocusMode = !current.settings.focusMode;
      updateSettings({ focusMode: newFocusMode });
      announce(newFocusMode ? 'Focus mode enabled' : 'Focus mode disabled');
    }
  });

  // Subscribe to settings changes
  progressStore.subscribe((progress) => {
    updateFontSizeUI(progress.settings.fontSize);
    updateFocusModeUI(progress.settings.focusMode);
  });

  // Apply initial settings
  const initialSettings = progressStore.get().settings;
  updateFontSizeUI(initialSettings.fontSize);
  updateFocusModeUI(initialSettings.focusMode);
</script>
