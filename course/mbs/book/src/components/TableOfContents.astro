---
/**
 * Table of Contents component
 * Displays a sticky sidebar TOC for chapter navigation
 */
import type { TocEntry } from '@repo/book-viewer/lib';

interface Props {
  entries: TocEntry[];
}

const { entries } = Astro.props;
---

{entries.length > 0 && (
  <nav class="text-sm" aria-label="Table of contents">
    <h2 class="font-semibold text-gray-900 dark:text-white mb-3">
      On this page
    </h2>
    <ul class="space-y-2">
      {entries.map((entry) => (
        <li
          style={`padding-left: ${(entry.depth - 2) * 0.75}rem`}
          class="border-l-2 border-transparent"
        >
          <a
            href={`#${entry.slug}`}
            class="block py-1 pl-3 -ml-px text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-l-2 hover:border-blue-500 transition-colors"
            data-toc-link={entry.slug}
          >
            {entry.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<script>
  // Highlight current section in TOC based on scroll position
  function initTocHighlight() {
    const links = document.querySelectorAll('[data-toc-link]');
    if (links.length === 0) return;

    const headings = Array.from(links).map((link) => {
      const slug = link.getAttribute('data-toc-link');
      return document.getElementById(slug!);
    }).filter(Boolean) as HTMLElement[];

    function updateActiveLink() {
      const scrollY = window.scrollY;
      let activeIndex = 0;

      for (let i = 0; i < headings.length; i++) {
        if (headings[i].offsetTop <= scrollY + 100) {
          activeIndex = i;
        }
      }

      links.forEach((link, i) => {
        if (i === activeIndex) {
          link.classList.add('text-blue-600', 'dark:text-blue-400', 'border-l-2', 'border-blue-500');
          link.classList.remove('text-gray-600', 'dark:text-gray-400', 'border-transparent');
        } else {
          link.classList.remove('text-blue-600', 'dark:text-blue-400', 'border-l-2', 'border-blue-500');
          link.classList.add('text-gray-600', 'dark:text-gray-400');
        }
      });
    }

    window.addEventListener('scroll', updateActiveLink, { passive: true });
    updateActiveLink();
  }

  initTocHighlight();
</script>
